name: Publish to npm

on:
  release:
    types: [published]

permissions:
  id-token: write
  contents: read

concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  publish:
    name: Publish to npm Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Setup MoonBit
        run: |
          echo "Installing MoonBit CLI..."
          curl -fsSL https://cli.moonbitlang.com/install.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Log environment info
        run: |
          echo "=== Environment ==="
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "pnpm version: $(pnpm --version)"
          echo "MoonBit version: $(moon --version)"
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "=== End Environment ==="

      - name: Verify version match
        run: |
          # Version format:
          # - package.json: yyyy.MM.increment (e.g., 2026.1.5)
          # - moon.mod.json: 0.yyyyMM.increment (e.g., 0.202601.5)
          # The 0. prefix is required by mooncakes.io limitation

          RELEASE_VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${RELEASE_VERSION#v}"
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          MOONBIT_VERSION=$(node -p "require('./moon.mod.json').version")

          echo "Release version:     $VERSION"
          echo "package.json:        $PACKAGE_VERSION"
          echo "moon.mod.json:       $MOONBIT_VERSION"

          MISMATCH=false

          if [ "$VERSION" != "$PACKAGE_VERSION" ]; then
            echo "❌ Version mismatch between release tag and package.json"
            MISMATCH=true
          fi

          # Convert npm version to mooncakes format for comparison
          # e.g., 2026.1.5 → 0.202601.5
          IFS='.' read -r YEAR MONTH INCREMENT <<< "$PACKAGE_VERSION"
          EXPECTED_MOONBIT_VERSION="0.${YEAR}$(printf '%02d' "$MONTH").${INCREMENT}"

          if [ "$MOONBIT_VERSION" != "$EXPECTED_MOONBIT_VERSION" ]; then
            echo "❌ Version mismatch: moon.mod.json should be $EXPECTED_MOONBIT_VERSION"
            MISMATCH=true
          fi

          if [ "$MISMATCH" = true ]; then
            exit 1
          fi

          echo "✅ Version verified: $VERSION"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package
        run: |
          echo "Building jww-parser@$(node -p "require('./package.json').version")"
          pnpm run build

      - name: Verify distribution files
        run: |
          echo "Checking distribution files..."
          ls -lh dist/
          [ -f dist/index.mjs ] || { echo "❌ Missing dist/index.mjs"; exit 1; }
          [ -f dist/index.cjs ] || { echo "❌ Missing dist/index.cjs"; exit 1; }
          [ -f dist/index.d.ts ] || { echo "❌ Missing dist/index.d.ts"; exit 1; }
          echo "✅ All distribution files present"

      - name: Publish to npm with provenance
        run: |
          echo "Publishing to npm registry..."
          npm publish --provenance --access public
          echo "✅ Successfully published to npm"

      - name: Verify npm package
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "Verifying npm package: jww-parser@$PACKAGE_VERSION"
          # Wait a moment for npm to process the new version
          sleep 3
          npm view jww-parser@$PACKAGE_VERSION dist.tarball || {
            echo "⚠️  Package verification delayed (npm replication)"
          }

      - name: Release summary
        if: success()
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "✅ Release successful!"
          echo ""
          echo "Package: jww-parser@$PACKAGE_VERSION"
          echo "npm URL: https://www.npmjs.com/package/jww-parser/v/$PACKAGE_VERSION"
          echo "GitHub Release: ${{ github.event.release.html_url }}"

      - name: Release failed notification
        if: failure()
        run: |
          echo "❌ Release failed!"
          echo "Please check the logs above for details."
          exit 1
